"use strict";function renderOption(a){var b=$("#location span");a&&0==a.status&&a.result?b.html(a.result.formatted_address):b.html("定位失败")}Z(function(){function a(){var a,b,c=k.length;for(b=0;c>b;b++)k[b].refresh(),a=k[b].getOption("browse_button")[0],Z(a).width()<1&&(k[b].destroy(),k.splice(b,1),c--,b--)}function b(a){var b=Z("#"+a).val();return b&&b.length?b:(Z("#"+a).addClass("warning").focus(),!1)}function c(){n||(n=!0,h.ajax({url:window.actionUrl.getDatingTaskDetail.url,type:window.actionUrl.getDatingTaskDetail.type,data:h.extend({actId:d,actToken:e,fNum:f,taskId:g},getCommonReqData()),success:function(b){if(console.log("getTaskDetail reply",b),b=checkReply(b)){var c="";if(0==b.flag){c="已完成任务: "+b.title,h("#input").html(b.reply||"");var d,e=b.photos||[],f=e.length,g="",i={};for(d=0;f>d;d++)i.fid="",i.text="",i.osrc=e[d],g+=format(l,i);h(g).insertBefore(h("#qnPicker"));var k=Math.ceil(4.5*window.fontSize),m=j+qnImg.and+qnImg.min(k*window.dpi,k*window.dpi);h("#qnCon").find(".imgBlock").each(function(){var a=h(this).removeClass("ing");if(!a.hasClass("empty")){var b=a.attr("osrc")+m;lazyLoadImg(b,a)}}),a()}else c="新任务: "+b.title;h("#title").html(c)}},error:function(a){noNetwork()},complete:function(){n=!1}}))}var d=getValueFromSearch("actId"),e=getValueFromSearch("actToken"),f=getValueFromSearch("fNum"),g=getValueFromSearch("taskId"),h=Z,i=!1,j="?"+qnImg.base(),k=[],l=['<div class="imgBlock bgCon ing" fid="{fid}" osrc="{osrc}">','<img class="delete" src="'+window.imgUrl.close+'">','<div class="text">{text}</div>','<div class="progress"></div>',"</div>"].join("");h(window).on("resize",a),qiNiuReady(function(){var a=myUp({bb:"qnPicker",con:"qnCon"});k.push(a),a.bind("FileUploaded",function(a,b,c){console.log("FileUploaded",b.id,arguments);var d=a.getOption("domain");c=JSON.parse(c.response);var e=Math.ceil(4.5*window.fontSize),f=j+qnImg.and+qnImg.min(e*window.dpi,e*window.dpi),g=d+c.key,i=g+f;console.log("domain",d,"info",c,"key",c.key,"osrc",g),h(".imgBlock").each(function(){var a=h(this);a.attr("fid")==b.id&&(a.removeClass("ing").find(".progress").css("top",100-b.percent+"%"),lazyLoadImg(i,a.attr("osrc",g)))})}),a.bind("BeforeUpload",function(a,b){console.log("BeforeUpload",b.id);var c={fid:b.id,text:"上传中",osrc:""},d=format(l,c);Z(d).insertBefore(Z("#qnPicker"))}),a.bind("UploadProgress",function(a,b){console.log("UploadProgress",b.id,b.percent),h(".imgBlock").each(function(){h(this).attr("fid")==b.id&&Z(this).find(".progress").css("top",100-b.percent+"%")})})}),h("#qnCon").on("click",".delete",function(){if(confirm("确认要删除这张头像吗")){var b=Z(this).parent();b.addClass("empty").remove(),a()}}).on("click",".imgBlock",function(a){if(!h(this).hasClass("empty")){for(var b=a.target;!h(b).hasClass("imgBlock");){if(h(b).hasClass("delete"))return;b=b.parentNode}var c=h(this).attr("osrc")+j;if(c){var d=[];h("#qnCon .imgBlock").each(function(){if(!h(this).hasClass("empty")){var a=h(this).attr("osrc");a&&d.push(a+j)}}),wxPreviewImg(c,d)}}});var m=!1;Z("#submit").on("click",function(){if(!m){var a=b("input");if(a){var c,i,j=Z("#qnCon").find(".imgBlock"),k=[],l=j.length;for(c=0;l>c;c++)i=h(j[c]),i.hasClass("empty")||k.push(i.attr("osrc"));if(k.length<2)return void alert("请上传至少两张照片");m=!0,h("#submit").html("发布中...");var n={actId:d,actToken:e,reply:a,taskId:g,photos:k};console.log("reqData",n),Z.ajax({url:window.actionUrl.registerAct.url,type:window.actionUrl.registerAct.type,data:Z.extend(getCommonReqData(),n),success:function(a){console.log("submit reply",a),a=checkReply(a),a&&(0==a.status?(alert("发布成功"),window.history.length?window.history.go(-1):window.location.href="dating.html"+getCommonParams()+"&actId="+encodeURIComponent(d)+"&actToken="+e+"&fNum="+encodeURIComponent(f)):alert("噫，发布失败了，请重试一下吧"))},error:function(a){alert("噫，发布失败了，请重试一下吧")},complete:function(){m=!1,Z("#submit").html("发布")}})}}}),getLocation("renderOption");var n=!1;h.ajax({url:window.actionUrl.getActDetail.url,type:window.actionUrl.getActDetail.type,data:h.extend({actId:d,actToken:e},getCommonReqData()),success:function(a){if(a=checkReply(a)){var b,d,e,g=a.females,h=a.males,j=g.length;for(b=0;j>b;b++)if(g[b].guestNumber==f){d=g[b];break}for(b=0;j>b;b++)if(h[b].guestNumber==d.linkedNumber){e=h[b];break}window.uid!=d.guestId&&window.uid!=e.guestId?(i=!0,alert("噫，出错了，这好像不是你的约会任务哎"),window.history.go(-1)):c()}},error:function(a){noNetwork()}})});
//# sourceMappingURL=taskPublish.js.map