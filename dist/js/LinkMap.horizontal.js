"use strict";function LinkMap(a,b){if(!a)throw"no canvas";if(b=b||{},this.pairs=b.pairs||5,!b.females||!b.females.length||b.females.length!=this.pairs)throw"females invalid";if(!b.males||!b.males.length||b.males.length!=this.pairs)throw"males invalid";this.scale=window.devicePixelRatio||2;var c,d,e;if(b.disorder)for(c=0;c<this.pairs;c++)e=Math.floor(this.pairs*Math.random()),d=b.females[c],b.females[c]=b.females[e],b.females[e]=d,e=Math.floor(this.pairs*Math.random()),d=b.males[c],b.males[c]=b.males[e],b.males[e]=d;this.topIs=b.topIs||"f";var f="f"==this.topIs,g=!f;for(this.females=[],this.males=[],c=0;c<this.pairs;c++)this.females.push(new LinkPerson(b.females[c],0,this,f)),this.males.push(new LinkPerson(b.males[c],1,this,g));this.femaleTextColor=b.femaleTextColor||"#fff",this.femaleTextBg=b.femaleTextBg||"#F641BF",this.maleTextColor=b.maleTextColor||"#fff",this.maleTextBg=b.maleTextBg||"#0092F4",this.textSize=this.scale*(b.textSize||10),this.defaultFemaleHead=b.defaultFemaleHead||"",this.defaultMaleHead=b.defaultMaleHead||"",this.defaultMaleImg=document.createElement("img"),this.defaultFemaleImg=document.createElement("img"),this.deskHeight=this.scale*(b.deskHeight||140),this.deskMarginTop=this.scale*(b.deskMarginTop||9),this.deskColor=b.deskColor||"#F0EFF5",this.deskRadius=this.scale*(b.deskRadius||5),this.topPadding=this.scale*(b.topPadding||18),this.headSize=this.scale*(b.headSize||35),this.thickness=this.scale*(b.thickness||1),this.dotSize=this.scale*(b.dotSize||5),this.dotGapDesk=this.scale*(b.dotGapDesk||18),this.lineWidth=this.scale*(b.lineWidth||1),this.neckDefaultColor=b.neckDefaultColor||"#999F9D",this.dotDefaultColor=b.dotDefaultColor||"#fff",this.linkColor=b.linkColor||"#EA4C89",this.linking=!1,this.deltaY=this.scale*(b.deltaY||-30),this.isMobile=!!navigator.userAgent.match(/AppleWebKit.*Mobile.*/),this.isMobile||(this.deltaY=0);var h=b.width||a.parentNode.offsetWidth,i=2*this.topPadding+2*this.headSize+2*this.deskMarginTop+this.deskHeight;return a.style.width=h+"px",a.style.height=i/this.scale+"px",a.width=h*this.scale,a.height=i,this.deskMarginLeft=a.width/30,this.deskWidth=a.width-2*this.deskMarginLeft,this.headSideGap=this.deskWidth/30,this.headBetweenGap=(this.deskWidth-2*this.headSideGap-this.pairs*this.headSize)/(this.pairs-1),this.canvas=a,this.onClick=b.onClick,this.onLink=b.onLink,this.onBreak=b.onBreak,this.onChoose=b.onChoose,this.onCancel=b.onCancel,this.canLink=b.canLink,this.allIsWell=!1,this.readyNum=0,this.showGuest=b.showGuest||0,this.init(),this}function LinkPerson(a,b,c,d){this.parent=c;for(var e in a)this[e]=a[e];return this.sex=b,this.isTop=d,this.pos={x:0,y:0},this.started=!1,this.selected=!1,this.lineEnd={x:0,y:0},this.partner=null,this.eventListener={},this.init(),this.scale=0,this}LinkMap.prototype.init=function(){var a,b=this;b.defaultFemaleImg.onload=function(){b.defaultFemaleReady=!0,b.defaultFemaleCanvas=b.males[0].drawCanvas(this),b.loadDefault()},b.defaultMaleImg.onload=function(){b.defaultMaleReady=!0,b.defaultMaleCanvas=b.males[0].drawCanvas(this),b.loadDefault()},b.defaultFemaleImg.src=b.defaultFemaleHead,b.defaultMaleImg.src=b.defaultMaleHead,b.touchstart=!1,b.mousemoved=!1,b.mousedown=!1;var c;b.canvas.addEventListener("touchstart",function(d){d.changedTouches.length>1||b.touchstart||!b.canLink()||!b.isReady()||(b.touchstart=!0,a=d.changedTouches[0].identifier,c=b.getTouchEventPos(d),b.eventPublish("touchstart",c))},!1),b.canvas.addEventListener("touchmove",function(c){if(b.canLink()&&c.preventDefault(),a==c.changedTouches[0].identifier&&b.canLink()&&b.isReady()){var d=b.getTouchEventPos(c);b.eventPublish("touchmove",d)}},!1),b.canvas.addEventListener("touchend",function(c){a==c.changedTouches[0].identifier&&b.canLink()&&b.isReady()&&(b.touchstart=!1,b.eventPublish("touchend",b.getTouchEventPos(c)))},!1),b.canvas.addEventListener("click",function(a){b.mousemoved||b.eventPublish("click",b.getMouseEventPos(a)),b.mousedown=!1,b.mousemoved=!1},!1);var d;b.isMobile||(b.canvas.addEventListener("mousedown",function(a){1==a.which&&b.canLink()&&b.isReady()&&(b.mousedown=!0,d=b.getMouseEventPos(a),b.eventPublish("touchstart",d))},!1),document.body.addEventListener("mousemove",function(a){if(a.preventDefault(),1==a.which&&b.mousedown&&b.canLink()&&b.isReady()){b.mousemoved=!0;var c=b.getMouseEventPos(a);b.eventPublish("touchmove",c)}},!1),document.body.addEventListener("mouseup",function(a){1==a.which&&b.canLink()&&b.isReady()&&b.eventPublish("touchend",b.getMouseEventPos(a))},!1)),window.addEventListener("resize",function(){b.onresize()},!1),b.onresize()},LinkMap.prototype.loadDefault=function(){var a,b=this;if(b.defaultFemaleReady&&b.defaultMaleReady&&(b.defaultReady=!0,b.draw(),b.showGuest))for(a=0;a<b.pairs;a++)b.males[a].loadHead(),b.females[a].loadHead()},LinkMap.prototype.onReady=function(a){function b(a){function d(){return f.scale=Math.min(100,f.scale+10),c.draw(),f.scale>=100?void setTimeout(function(){b(a+1)},50):void h(d)}if(a>=2*c.pairs)return c.allIsWell=!0,void c.draw();var f=e[a];d()}var c=this;if(c.readyNum++,!(c.readyNum<2*c.pairs)){var d,e=[];for(c.draw(),d=0;d<c.pairs;d++)e.push(c.females[d]),e.push(c.males[d]);var f,g;for(d=0;d<2*c.pairs;d++)f=Math.floor(2*Math.random()*c.pairs),g=e[d],e[d]=e[f],e[f]=g;var h=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,17)};b(0)}},LinkMap.prototype.onresize=function(){var a,b=this,c=b.canvas.parentNode.offsetWidth;b.canvas.style.width=c+"px",b.canvas.width=c*b.scale,b.deskMarginLeft=b.canvas.width/30,b.deskWidth=b.canvas.width-2*b.deskMarginLeft,b.headSideGap=b.deskWidth/30,b.headBetweenGap=(b.deskWidth-2*b.headSideGap-b.pairs*b.headSize)/(b.pairs-1);var d;for(a=0;a<b.pairs;a++)b.males[a].setIndex(a),b.females[a].setIndex(a);for(a=0;a<b.pairs;a++)d=b.females[a],d.isLinked()&&d.linkedWith(d.getPartner());b.defaultReady&&b.draw()},LinkMap.prototype.isReady=function(){return this.allIsWell},LinkMap.prototype.draw=function(){var a,b=this,c=b.canvas.getContext("2d"),d=b.canvas.width,e=b.canvas.height;c.clearRect(0,0,d,e);var f=b.deskMarginLeft,g=b.topPadding+b.headSize+b.deskMarginTop,h=(b.deskWidth,b.deskHeight,b.deskRadius);for(c.fillStyle=b.deskColor,c.beginPath(),c.moveTo(f+h,g),c.lineTo(d-f-h,g),c.arc(d-f-h,g+h,h,1.5*Math.PI,2*Math.PI),c.lineTo(d-f,e-g-h),c.arc(d-f-h,e-g-h,h,0*Math.PI,.5*Math.PI),c.lineTo(f+h,e-g),c.arc(f+h,e-g-h,h,.5*Math.PI,1*Math.PI),c.lineTo(f,g+h),c.arc(f+h,g+h,h,1*Math.PI,1.5*Math.PI),c.closePath(),c.fill(),a=0;a<this.pairs;a++)b.females[a].drawImg(),b.males[a].drawImg();for(a=0;a<this.pairs;a++)b.females[a].drawLine(),b.males[a].drawLine()},LinkMap.prototype.reset=function(){var a,b,c,d=this;for(a=0;a<this.pairs;a++)c=Math.floor(this.pairs*Math.random()),b=d.females[a],d.females[a]=d.females[c],d.females[c]=b,c=Math.floor(this.pairs*Math.random()),b=d.males[a],d.males[a]=d.males[c],d.males[c]=b;for(a=0;a<this.pairs;a++)d.females[a].loseLink(),d.males[a].loseLink(),d.females[a].setIndex(a),d.males[a].setIndex(a);d.draw()},LinkMap.prototype.trigger=function(a){"function"==typeof this[a]&&this[a](Array.prototype.splice.call(arguments,1))},LinkMap.prototype.getMouseEventPos=function(a){var b=this;return a?{x:b.scale*(a.pageX-b.canvas.offsetLeft),y:b.scale*(a.pageY-b.canvas.offsetTop)}:{x:0,y:0}},LinkMap.prototype.getTouchEventPos=function(a){var b=this;return a&&a.changedTouches&&a.changedTouches.length?{x:b.scale*(a.changedTouches[0].pageX-b.canvas.offsetLeft),y:b.scale*(a.changedTouches[0].pageY-b.canvas.offsetTop)}:{x:0,y:0}},LinkMap.prototype.eventPublish=function(a,b){var c,d=this;for(c=0;c<d.pairs;c++)d.females[c].trigger(a,b),d.males[c].trigger(a,b)},LinkMap.prototype.linkStart=function(a,b){this.linking=!0,this.curStart=a,a.linkStart(b)},LinkMap.prototype.linkedWith=function(a){this.curStart.linkedWith(a),a.linkedWith(this.curStart),this.trigger("onLink",this.curStart,a)},LinkMap.prototype.linkEnd=function(a){this.linking=!1},LinkMap.prototype.isLinking=function(){return this.linking},LinkMap.prototype.checkLine=function(a){return this.curStart&&this.curStart.isTop!=a.isTop?!0:!1},LinkMap.prototype.getLinkResult=function(){var a,b,c={},d=this;for(a=0;a<d.pairs;a++){if(b=d.males[a],!b.isLinked())return!1;c[b.guestNumber]=b.getPartner().guestNumber}return c},LinkMap.prototype.link=function(a,b){var c,d,e,f=this;for(c=0;c<f.pairs;c++)f.males[c].guestNumber==a&&(d=f.males[c]),f.females[c].guestNumber==b&&(e=f.females[c]);d.linkedWith(e),e.linkedWith(d)},LinkPerson.prototype.init=function(){var a=this;a.on("touchstart",function(b){var c=a.parent;a.checkPosInBox(b)&&!c.isLinking()&&(a.isLinked()?(c.trigger("onBreak",a,a.getPartner()),c.trigger("onChoose",a),c.trigger("onChoose",a.getPartner()),a.getPartner().loseLink(),c.linkStart(a.getPartner(),b),a.loseLink(),a.beSelected()):(c.linkStart(a,b),c.trigger("onChoose",a)),c.draw())}),a.on("touchmove",function(b){if(!a.isLinked()){var c=a.parent;a.checkPosInBox(b)?c.isLinking()?a.isSelected()?a.isStarted()&&(a.lineTo(b),c.draw()):c.checkLine(a)&&(a.beSelected(),c.trigger("onChoose",a),c.draw()):a.trigger("touchstart",b):a.isSelected()&&(a.isStarted()?a.lineTo(b):(a.loseSelect(),c.trigger("onCancel",a)),c.draw())}}),a.on("touchend",function(b){if(!a.isLinked()&&a.isSelected()){var c=a.parent;c.linkEnd(),a.checkPosInBox(b)?a.isStarted()?(a.linkCancel(),c.trigger("onCancel",a),c.draw()):c.checkLine(a)&&(c.linkedWith(a),c.draw()):a.isStarted()&&setTimeout(function(){a.isLinked()||(a.linkCancel(),c.trigger("onCancel",a),c.draw())},0)}}),a.on("click",function(b){var c=a.parent;a.checkPosInBox(b)&&c.trigger("onClick",a)})},LinkPerson.prototype.loadHead=function(){var a=this;a.img=document.createElement("img"),a.img.onload=function(){a.imgReady=!0,a.canvas=a.drawCanvas(this,!0),a.parent.onReady(a)},a.img.src=a.headImg},LinkPerson.prototype.drawCanvas=function(a,b){var c,d,e,f,g=this,h=g.parent,i=h.headSize-2*h.thickness,j=document.createElement("canvas");j.width=i,j.height=i;var k=j.getContext("2d");a.width<a.height?(f=i/a.width,c=f*a.height,d=0,e=(i-c)/2,k.drawImage(a,d,e,i,c)):(f=i/a.height,c=f*a.width,d=(i-c)/2,e=0,k.drawImage(a,d,e,c,i));var l=i/2,m=i/2,n=i/2;return k.save(),k.beginPath(),k.arc(l,m,n,0,.5*Math.PI),k.lineTo(l+n,m+n),k.closePath(),k.clip(),k.clearRect(0,0,i,i),k.restore(),k.save(),k.beginPath(),k.arc(l,m,n,.5*Math.PI,1*Math.PI),k.lineTo(l-n,m+n),k.closePath(),k.clip(),k.clearRect(0,0,i,i),k.restore(),k.save(),k.beginPath(),k.arc(l,m,n,1*Math.PI,1.5*Math.PI),k.lineTo(l-n,m-n),k.closePath(),k.clip(),k.clearRect(0,0,i,i),k.restore(),k.save(),k.beginPath(),k.arc(l,m,n,1.5*Math.PI,2*Math.PI),k.lineTo(l+n,m-n),k.closePath(),k.clip(),k.clearRect(0,0,i,i),k.restore(),b?j:j},LinkPerson.prototype.drawImg=function(){var a=this,b=a.parent,c=b.canvas.getContext("2d"),d=b.dotSize/2,e=a.getDotPos(),f=e.x,g=e.y;a.isLinked()||a.isSelected()?c.fillStyle=b.linkColor:c.fillStyle=b.dotDefaultColor,c.beginPath(),c.arc(f,g,d,0,2*Math.PI),c.closePath(),c.fill();var h;h=0==a.sex?b.defaultFemaleCanvas:b.defaultMaleCanvas;var i,j;i=a.pos.x+b.thickness,j=a.pos.y+b.thickness;var k=b.headSize-2*b.thickness;a.scale<100&&c.drawImage(h,i,j,k,k);var l=a.pos.x+b.headSize/2,m=a.pos.y+b.headSize/2,n=b.headSize/2,o=k/2;if(a.isSelected()?c.fillStyle=b.linkColor:c.fillStyle=b.neckDefaultColor,c.beginPath(),c.arc(l,m,n,0,1*Math.PI),c.lineTo(l-n+b.thickness,m),c.arc(l,m,o,1*Math.PI,0,!0),c.closePath(),c.fill(),c.beginPath(),c.arc(l,m,n,1*Math.PI,2*Math.PI),c.lineTo(l+n-b.thickness,m),c.arc(l,m,o,2*Math.PI,1*Math.PI,!0),c.closePath(),c.fill(),!(a.scale<1)){h=a.canvas,i=a.pos.x+b.thickness+o*(100-a.scale)/100,j=a.pos.y+b.thickness+o*(100-a.scale)/100,c.globalAlpha=a.scale/100,c.drawImage(h,i,j,k*a.scale/100,k*a.scale/100),c.globalAlpha=1;var p=b.maleTextColor,q=b.maleTextBg,r="男";0==a.sex&&(p=b.femaleTextColor,q=b.femaleTextBg,r="女");var s=r+a.guestNumber+" "+a.nickname,t=Math.floor(a.pos.x+.7*k),u=a.pos.y;c.font=b.textSize+"px Arial",c.textBaseline="top",c.lineWidth=Math.floor(.7*b.textSize),c.strokeStyle=q,c.lineJoin="round",c.strokeText(s,t,u),c.fillStyle=p,c.fillText(s,t,u)}},LinkPerson.prototype.drawLine=function(){var a=this,b=a.parent;if(b.isReady()){if(a.isLinked()){if(a.getPartner().isTop)return}else if(!a.isStarted())return;var c=b.canvas.getContext("2d");c.lineWidth=b.lineWidth,c.strokeStyle=b.linkColor,c.beginPath();var d=a.getDotPos();c.moveTo(d.x,d.y),c.lineTo(a.lineEnd.x,a.lineEnd.y),c.stroke(),c.beginPath(),c.arc(a.lineEnd.x,a.lineEnd.y,b.dotSize/2,0,2*Math.PI),c.fillStyle=b.linkColor,c.fill()}},LinkPerson.prototype.setIndex=function(a){var b=this,c=b.parent;b.index=a,b.isTop?b.pos.y=c.topPadding:b.pos.y=c.canvas.height-c.topPadding-c.headSize,b.pos.x=c.deskMarginLeft+c.headSideGap+a*(c.headSize+c.headBetweenGap)},LinkPerson.prototype.getLeft=function(){var a=this,b=a.parent,c=a.index-1;return 0>c?0==a.sex?b.males[b.pairs-1]:b.females[b.pairs-1]:0==a.sex?b.females[c]:b.males[c]},LinkPerson.prototype.getRight=function(){var a=this,b=a.parent,c=a.index+1;return c>=b.pairs?0==a.sex?b.males[0]:b.females[0]:0==a.sex?b.females[c]:b.males[c]},LinkPerson.prototype.getPartner=function(){return this.partner},LinkPerson.prototype.linkedWith=function(a){this.partner=a;var b=this.partner.getDotPos();this.lineEnd.x=b.x,this.lineEnd.y=b.y,this.linkCancel()},LinkPerson.prototype.loseLink=function(){this.partner=null,this.linkCancel()},LinkPerson.prototype.isLinked=function(){return!!this.partner},LinkPerson.prototype.beSelected=function(){this.selected=!0},LinkPerson.prototype.loseSelect=function(){this.selected=!1},LinkPerson.prototype.isSelected=function(){return this.selected},LinkPerson.prototype.linkStart=function(a){this.selected=!0,this.started=!0,this.lineTo(a)},LinkPerson.prototype.linkCancel=function(){this.selected=!1,this.started=!1},LinkPerson.prototype.isStarted=function(){return this.started},LinkPerson.prototype.lineTo=function(a){this.lineEnd.x=a.x,this.lineEnd.y=a.y+this.parent.deltaY},LinkPerson.prototype.getDotPos=function(){var a,b,c=this,d=c.parent,e=d.dotSize/2;return b=c.isTop?c.pos.y+d.headSize+d.deskMarginTop+d.dotGapDesk+e:c.pos.y-d.deskMarginTop-d.dotGapDesk-e,a=c.pos.x+d.headSize/2,{x:a,y:b}},LinkPerson.prototype.checkPosInBox=function(a){if(!a)return!1;var b,c,d,e,f=this,g=f.parent,h=.4*g.headBetweenGap,i=g.headSize+2*h,j=g.headSize+g.deskMarginTop+g.dotGapDesk+g.dotSize+2*h;c=f.isTop?f.pos.y-h:f.pos.y-g.deskMarginTop-g.dotGapDesk-g.dotSize-h,b=f.pos.x-h,d=a.x-b,e=a.y-c+g.deltaY;var k=d>=0&&i>=d&&e>=0&&j>=e;return k},LinkPerson.prototype.checkPosInSegment=function(a,b,c){var d=Math.max(a.y,b.y),e=Math.min(a.y,b.y),f=Math.max(a.x,b.x),g=Math.min(a.x,b.x);return c.x>=g&&c.x<=f&&c.y>=e&&c.y<=d},LinkPerson.prototype.checkCross=function(a){if(!a)return!1;var b,c=this,d=c.getDotPos(),e=c.getPartner().getDotPos(),f=d.x-e.x,g=999999999;b=0==f?g:(d.y-e.y)/f;var h=d.y-d.x*b,i=a.st,j=a.et;f=i.x-j.x;var k;k=0==f?g:(i.y-j.y)/f;var l=i.y-i.x*k;if(b==k)return!1;var m={x:0,y:0};return b==g?0==k?(m.x=d.x,m.y=i.y):(m.x=d.x,m.y=k*m.x+l):k==g?0==b?(m.x=i.x,m.y=d.y):(m.x=i.x,m.y=b*m.x+h):0==b?(m.x=(d.y-l)/k,m.y=d.y):0==k?(m.x=(i.y-h)/b,m.y=i.y):(m.x=(l-h)/(b-k),m.y=b*m.x+h),c.checkPosInSegment(d,e,m)&&c.checkPosInSegment(i,j,m)},LinkPerson.prototype.trigger=function(a,b){var c,d;if(a in this.eventListener)for(d=this.eventListener[a].length,c=0;d>c;c++)this.eventListener[a][c](b)},LinkPerson.prototype.on=function(a,b){"string"==typeof a&&"function"==typeof b&&(a in this.eventListener||(this.eventListener[a]=[]),this.eventListener[a].push(b))};
//# sourceMappingURL=LinkMap.horizontal.js.map