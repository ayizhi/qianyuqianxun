<<<<<<< HEAD
var $=window.Z;$(function(){var a=getValueFromSearch("actId"),b=function(a,b,e){function f(a){var c=b("#danmu .discussZone"),e=a.length;return 1>e?void c.html(""):void d.init(c,a)}function g(){m.refreshListIng||b.ajax({url:window.actionUrl.getBarrage.url,type:window.actionUrl.getBarrage.type,data:getCommonReqData(),success:function(a){a=checkReply(a),a&&(m.data=a.list)},error:function(a){noNetwork()},complete:function(){m.refreshListIng=!1}})}function h(a){var d=b("#danmu .myComment"),e=a.length;return 1>e?void d.html(""):void c.init(d,a)}function i(){m.refreshComment||(m.refreshComment=!0,b.ajax({url:window.actionUrl.getUserInfo.url,type:window.actionUrl.getUserInfo.type,data:getCommonReqData(),success:function(a){a=checkReply(a),a&&h(a)},error:function(a){noNetwork()},complete:function(){m.refreshComment=!1}}))}var j,k,l,m={main_html:['<div class = "switch">','<div class = "danmuTitle">弹幕</div>','<div class = "greenBg">','<div class = "button"></div>',"</div>","</div>",'<div class = "discussZone" ></div>','<div class = "myComment"></div>'].join(""),refreshListIng:!1,refreshComment:!1,controller:-1};return j=function(a){m.$container=a,k(),l()},k=function(){var a=m.$container,b=m.main_html;a.html(b)},l=function(){var a=!0;g(),b("#danmu .switch").on("click",function(){if(0!=a)switch(a=!1,m.controller*=-1,m.controller){case-1:b("#danmu .discussZone").html(""),b("#danmu .myComment").html(""),b("#danmu .switch .greenBg").css({backgroundColor:"#a1a0a0"}),b("#danmu .switch .button").css("left","0.035rem"),setTimeout(function(){a=!0},500),m.refreshListIng=!0,window.tt.stop();break;case 1:b("#danmu .switch .greenBg").css({backgroundColor:"#1ead66"}),b("#danmu .switch .button").css("left","0.735rem"),setTimeout(function(){a=!0},500),m.refreshListIng=!1,f(m.data),i()}})},{init:j}}(window,$),c=function(b,c,e){function f(){j.refreshComment||(j.refreshComment=!0,c.ajax({url:window.actionUrl.sendBarrage.url,type:window.actionUrl.sendBarrage.type,data:j.theNewCommonReqData,success:function(a){if(0!=a.status)throw error("发送失败");console.log("发送成功")},error:function(a){noNetwork()},complete:function(){j.refreshComment=!1}}))}var g,h,i,j={main_html:['<div class = "userComment">','<div class="commentZone">','<div class="myHeadImg"></div>','<input class = "theComment" type="text" placeholder = "请写下你的评论..."/>',"</div>",'<div class = "send">发射</div>',"</div>"].join(""),refreshComment:!1};return g=function(a,b){j.$container=a,j.data=b,h(),i()},h=function(){var a=j.$container,b=j.data;a.html(j.main_html),lazyLoadImg(b.headImg,c("#danmu .myComment .userComment .myHeadImg"))},i=function(){var b=c("#danmu .userComment .send"),e=c("#danmu .userComment .theComment"),g=10,h=!0;b.on("click",function(){if(0!=h){var i=e.attr("value");if(""!=i.trim()){var k={},l=Math.floor(Math.random()*(window.tt.canvas.height-window.tt.itemHeight));if(k.uniId=j.data.uniId,k.head=j.data.headImg,k.num=0,k.text=i,k.parent=window.tt,k.pos={x:window.tt.canvas.width+Math.floor(40*Math.random()+40),y:l},k.uniId in window.tt.itemMap)return void console.log(j.data.uniId+"这个元素已经存在");window.tt.itemMap[k.uniId]=new d.DanMuItem(k),f(),e.get(0).value="",b.css("backgroundColor","#cccccc"),b.html("10"),h=!1,j.theNewCommonReqData=c.extend(getCommonReqData(),{actId:a,text:i});var m=setInterval(function(){g--,0>=g?(b.css("backgroundColor","#2b9f2c"),b.html("发射"),g=10,h=!0,clearInterval(m)):b.html(g+"s")},1e3)}}})},window.String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")},{init:g}}(window,$),d=function(a,b,c){function d(c){l.refreshComment||(l.refreshComment=!0,b.ajax({url:a.actionUrl.praise.url,type:a.actionUrl.praise.type,data:b.extend(getCommonReqData(),{uniId:c}),success:function(a){if(0!=a.status)throw error("发送失败")},error:function(a){noNetwork()},complete:function(){l.refreshComment=!1}}))}function e(b){if(!b||!b.canvas)throw"弹幕的canvas未指定";this.canvas=b.canvas,this.ctx=this.canvas.getContext("2d");var c=Math.floor(b.boxWidth||document.body.offsetWidth),d=Math.floor(b.boxHeight||500);this.canvas.style.width=c+"px",this.canvas.style.height=d+"px",this.dpi=a.devicePixelRatio||2,this.canvas.width=Math.floor(this.dpi*c),this.canvas.height=Math.floor(this.dpi*d),this.itemHeight=Math.floor(this.dpi*(b.itemHeight||30)),this.itemBorderColor=b.itemBorderColor||"#ffffff",this.itemBorderSize=Math.floor(this.dpi*(b.itemBorderSize||2)),this.bgColor=b.bgColor||"rgba(0,0,0,0.5)",this.textColor=b.textColor||"#ffffff",this.textSize=Math.floor(this.dpi*(b.textSize||14)),this.maxText=b.maxText||30,this.zanEmptyImg=b.zanEmptyImg,this.zanFillImg=b.zanFillImg,this.zanWidth=Math.floor(this.dpi*(b.zanWidth||18)),this.minSpeed=Math.floor(this.dpi*(b.minSpeed||5)),this.maxSpeed=Math.floor(this.dpi*(b.maxSpeed||10)),this.data=b.data||[],this.minNum=b.minNum||10,this.uni=0,this.zanOnload=!1,this.init()}function f(a){return this.parent=a.parent,this.head=a.head,this.text=a.text.substring(0,this.parent.maxText),this.num=a.num,this.pos=a.pos,this.uniId=a.uniId,this.ts=a.ts,this.hasNiced=!1,this.colorList=["rgb(112, 126, 172)","rgb(164, 75, 194)","rgb(121, 165, 86)","rgb(176, 67, 101)","rgb(83, 58, 183)","rgb(110, 178, 148)","#d73027","#b2182b","#4daf4a","#ff7f00","#984ea3"],this.niceColor=this.colorList[Math.floor(Math.random()*this.colorList.length)],this.init(),this}var g,h,i,j,k,l={main_html:['<canvas id = "discussCanvas" ></canvas>'].join("")};return g=function(a,b){l.data=b,l.$container=a,h(),i(),j()},k=parseInt(b(document.body).css("font-size")),h=function(){l.$container.html(l.main_html),l.canvas=document.getElementById("discussCanvas"),l.theBodyWidth=b(document.body).width(),l.theCanvasHeight=20.1*k,l.canvas.style.width=l.theBodyWidth+"px",l.canvas.style.height=l.theCanvasHeight+"px",l.canvas.width=dpi*l.theBodyWidth,l.canvas.height=dpi*l.theCanvasHeight},i=function(){a.tt=new e({canvas:Z("#discussCanvas")[0],data:l.data,minSpeed:1,maxSpeed:3.1,minNum:4,itemHeight:30,boxHeight:300,itemBorderSize:2,itemBorderColor:"#fff",textColor:"#fff",textSize:14,maxText:30,zanEmptyImg:"../img/danmu/zanEmpty.png",zanFillImg:"../img/danmu/zanFill.png",zanWidth:18,bgColor:"rgba(0,0,0,0.5)"}),a.tt.start()},j=function(){b("#discussCanvas").get(0).addEventListener("touchend",function(a){var b=a.changedTouches[0].clientX,c=a.changedTouches[0].clientY-4.8*k,e=tt.itemHeight,f={};for(var g in tt.itemMap){var h=tt.itemMap[g];b>=h.pos.x/dpi&&b<=(h.pos.x+h.canvas.width)/dpi&&c>=h.pos.y/dpi&&c<=(h.pos.y+e)/dpi&&(f=h)}f&&!f.hasNiced&&(d(f.uniId),f.hasNiced=!0,f.num++)})},e.prototype.unikey=function(){return"k"+ ++this.uni},e.prototype.add=function(a){if(a){var b,c,d=this,e=0;for(e=0;a>e;e++)d.dataIndex=d.dataIndex+1>=d.data.length?0:d.dataIndex+1,b=d.data[d.dataIndex],c=Math.floor(Math.random()*(d.canvas.height-d.itemHeight)),d.itemMap[d.unikey()]=new f({parent:d,uniId:b.uniId||0,head:b.headImg||"",text:b.text||"",num:b.praised||0,ts:b.ts||0,pos:{x:d.canvas.width+Math.floor(40*Math.random()+40),y:c}})}},e.prototype.start=function(){function b(){if(c.loop){var a;c.ctx.clearRect(0,0,c.canvas.width,c.canvas.height);var e=0;for(a in c.itemMap)c.itemMap[a].draw().move().died&&(delete c.itemMap[a],e++);c.add(e),d(b)}}var c=this;c.loop=!0;var d=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(b){a.setTimeout(b,17)};b()},e.prototype.stop=function(){this.loop=!1},e.prototype.init=function(){var a,b=this,c=b.itemBorderSize,d=b.itemHeight,e=b.itemBorderColor;b.headCanvas=document.createElement("canvas"),b.headCanvas.width=b.headCanvas.height=d,a=b.headCanvas.getContext("2d"),a.fillStyle=e;var f=d/2,g=f,h=f;a.beginPath(),a.arc(g,h,f,0,2*Math.PI),a.fill(),b.leftCircle=document.createElement("canvas"),b.leftCircle.height=d,b.leftCircle.width=Math.floor(d/2),a=b.leftCircle.getContext("2d"),a.fillStyle=b.bgColor,a.beginPath(),f=b.leftCircle.width-c,g=b.leftCircle.width,h=b.leftCircle.height/2,a.arc(g,h,f,.5*Math.PI,1.5*Math.PI),a.closePath(),a.fill(),a.fillStyle=e,a.beginPath(),a.moveTo(b.leftCircle.width,0),a.lineTo(b.leftCircle.width,c),a.arc(g,h,f,1.5*Math.PI,.5*Math.PI,!0),a.lineTo(b.leftCircle.width,b.leftCircle.height),f=b.leftCircle.width,a.arc(g,h,f,.5*Math.PI,1.5*Math.PI),a.closePath(),a.fill(),b.rightCircle=document.createElement("canvas"),b.rightCircle.height=d,b.rightCircle.width=Math.floor(d/2),a=b.rightCircle.getContext("2d"),a.fillStyle=b.bgColor,a.beginPath(),f=b.rightCircle.width-c,g=0,h=b.rightCircle.height/2,a.arc(g,h,f,1.5*Math.PI,.5*Math.PI),a.fill(),a.beginPath(),a.fillStyle=e,a.moveTo(0,0),a.lineTo(0,c),a.arc(g,h,f,1.5*Math.PI,.5*Math.PI),a.lineTo(0,b.rightCircle.height),f=b.rightCircle.width,a.arc(g,h,f,.5*Math.PI,1.5*Math.PI,!0),a.closePath(),a.fill(),b.centerBg=document.createElement("canvas"),b.centerBg.height=d,b.centerBg.width=b.centerBg.height;var i=b.centerBg.getContext("2d");i.fillStyle=b.bgColor,i.fillRect(0,c,b.centerBg.width,b.centerBg.height-2*c),i.fillStyle=e,i.fillRect(0,0,b.centerBg.width,c),i.fillRect(0,b.centerBg.height-c,b.centerBg.width,c);var j=new Image;j.src=b.zanEmptyImg,j.onload=function(){b.drawZan(this,"emptyZan"),delete this};var k=new Image;k.src=b.zanFillImg,k.onload=function(){b.drawZan(this,"fillZan"),delete this},b.itemMap={},b.dataIndex=0,b.add(b.minNum)},e.prototype.drawZan=function(a,b){var c=this;c.zanOnload=!0,c[b]=document.createElement("canvas"),c[b].width=a.width,c[b].height=a.height;var d=a.width,e=a.height;c[b].getContext("2d").drawImage(a,0,0,d,e)},f.prototype.init=function(){var a=this,b=a.parent;a.speed=Math.floor(b.minSpeed+Math.random()*(b.maxSpeed-b.minSpeed)),a.canvas=document.createElement("canvas"),a.canvas.height=b.itemHeight,a.rectWidth=(a.text.length+6)*b.textSize,a.canvas.width=a.rectWidth+b.itemHeight;var c=(""+a.num).length,d=a.num%10/10,e=Math.floor(b.zanWidth+b.textSize*c),f=Math.floor((a.canvas.width-b.itemHeight)*d-b.itemHeight);a.niceFullWidth=Math.floor(1*(a.canvas.width-b.itemHeight)-b.itemHeight),a.buttonWidth=Math.max(e,f),a.numWidth=c*b.textSize/1.5,a.niceWidth=3*b.textSize/2,a.died=!1,a.drawNiceContent(),a.drawNum("before"),a.drawNum("after"),a.drawBuff();var g=document.createElement("img");return g.onload=function(){a.drawHead(this),delete this},g.src=a.head,a},f.prototype.drawHead=function(a){var b=this;if(a&&!b.died){var c=b.parent,d=document.createElement("canvas"),e=d.getContext("2d"),f=a.width,g=a.height,h=c.itemHeight-2*c.itemBorderSize;d.width=h,d.height=h;var i,j,k,l;g>f?(i=h/f,j=i*g,k=0,l=(h-j)/2,e.drawImage(a,k,l,h,j)):(i=h/g,j=i*f,k=(h-j)/2,l=0,e.drawImage(a,k,l,j,h));var m=h/2,n=h/2,o=h/2;e.save(),e.beginPath(),e.arc(m,n,o,0,1*Math.PI),e.lineTo(0,h),e.lineTo(h,h),e.closePath(),e.clip(),e.clearRect(0,0,h,h),e.restore(),e.beginPath(),e.arc(m,n,o,0,1*Math.PI,!0),e.lineTo(0,0),e.lineTo(h,0),e.closePath(),e.clip(),e.clearRect(0,0,h,h);var p=c.itemBorderSize;e=b.canvas.getContext("2d"),e.drawImage(d,p,p)}},f.prototype.drawNiceContent=function(){var a,b=this,c=this.parent,d=c.itemHeight,e=c.itemBorderSize,f=b.canvas.height;b.rightNiceCircle=document.createElement("canvas"),b.rightNiceCircle.height=d,b.rightNiceCircle.width=Math.floor(d/2),a=b.rightNiceCircle.getContext("2d"),a.fillStyle=b.niceColor,a.beginPath();var g=b.rightNiceCircle.width-e,h=0,i=b.rightNiceCircle.height/2;a.arc(h,i,g,1.5*Math.PI,.5*Math.PI),a.fill(),b.leftNiceCircle=document.createElement("canvas"),b.leftNiceCircle.height=d,b.leftNiceCircle.width=Math.floor(d/2),a=b.leftNiceCircle.getContext("2d"),a.fillStyle=b.niceColor,a.beginPath();var g=b.leftNiceCircle.width-e,h=b.leftNiceCircle.width,i=b.leftNiceCircle.height/2;a.arc(h,i,g,.5*Math.PI,1.5*Math.PI),a.closePath(),a.fill(),b.niceCenterBg=document.createElement("canvas"),b.niceCenterBg.height=d,b.niceCenterBg.width=b.niceCenterBg.height;var j=b.niceCenterBg.getContext("2d");j.fillStyle=b.niceColor,j.fillRect(0,e,b.niceCenterBg.width,b.niceCenterBg.height-2*e),b.content=document.createElement("canvas"),b.content.height=d,b.content.width=b.canvas.width;var k=b.content.getContext("2d");k.fillStyle=c.textColor,k.font=c.textSize+"px Microsoft YaHei";var l=Math.floor(.5*f);k.textBaseline="middle",k.fillText(b.text,Math.floor(1.5*f),l)},f.prototype.drawBuff=function(){var a=this;if(a.died)return a;var b=a.parent,c=a.canvas.getContext("2d"),d=a.canvas.width,e=a.canvas.height;Math.floor(e/2),b.itemBorderSize;return c.drawImage(b.headCanvas,0,0),c.drawImage(b.leftCircle,e,0),c.drawImage(b.rightCircle,Math.floor(d-.5*e),0),c.drawImage(b.centerBg,Math.floor(1.5*e),0,Math.floor(d-2*e),e),a},f.prototype.drawNum=function(a){var b=this,c=this.parent,d=c.itemHeight,e=b.canvas.height,f=Math.floor(.5*e),g="before"==a?b.num:b.num+1,h=b.canvas.width;b[a+"Num"]=document.createElement("canvas"),b[a+"Num"].height=d,b[a+"Num"].width=b.canvas.width,b[a+"Num"].ctx=b[a+"Num"].getContext("2d"),b[a+"Num"].ctx.fillStyle=c.textColor,b[a+"Num"].ctx.font=c.textSize+"px Microsoft YaHei",b[a+"Num"].ctx.textBaseline="middle",b[a+"Num"].ctx.fillText(g,Math.floor(h-.5*e-c.zanWidth),f)},f.prototype.move=function(){var a=this;return a.pos.x-=a.speed,a.pos.x<-a.canvas.width&&a.die(),a},f.prototype.die=function(){var a=this;return a.died?a:(a.died=!0,delete a.canvas,a.canvas=null,a)},f.prototype.draw=function(){var a=this,b=a.parent,c=a.canvas.width,d=a.canvas.height,e=Math.floor(.4*(d-b.textSize)),f=a.pos.x+Math.floor(c-.5*d-b.zanWidth-a.niceWidth),g=a.pos.y+e,h=b.zanWidth;return!a.died&&a.pos.x<b.canvas.width&&(b.ctx.drawImage(a.canvas,a.pos.x,a.pos.y),a.hasNiced&&a.buttonWidth<=a.niceFullWidth&&(a.buttonWidth=Math.ceil(a.buttonWidth+(a.niceFullWidth-a.buttonWidth)/5)),b.ctx.drawImage(a.rightNiceCircle,a.pos.x+Math.floor(c-.5*d),a.pos.y),b.ctx.drawImage(a.niceCenterBg,a.pos.x+Math.floor(c-.5*d-a.buttonWidth),a.pos.y,a.buttonWidth,d),b.ctx.drawImage(a.leftNiceCircle,a.pos.x+Math.floor(c-.5*d-a.buttonWidth-.5*d),a.pos.y),b.ctx.drawImage(a.content,a.pos.x,a.pos.y),a.hasNiced?(b.ctx.drawImage(b.fillZan,f,g,h,h),b.ctx.drawImage(a.afterNum,a.pos.x,a.pos.y)):(b.ctx.drawImage(b.emptyZan,f,g,h,h),b.ctx.drawImage(a.beforeNum,a.pos.x,a.pos.y))),a},{init:g,DanMuItem:f}}(window,$);document.body.className="noTab",b.init($("#danmu"))});
//# sourceMappingURL=danmuUsecanvas.js.map
=======
var $=window.Z;$(function(){var a=getValueFromSearch("actId"),b=function(a,b,e){function f(a){var c=b("#danmu .discussZone"),e=a.length;return 1>e?void c.html(""):void d.init(c,a)}function g(){m.refreshListIng||b.ajax({url:window.actionUrl.getBarrage.url,type:window.actionUrl.getBarrage.type,data:getCommonReqData(),success:function(a){a=checkReply(a),a&&(m.data=a.list)},error:function(a){noNetwork()},complete:function(){m.refreshListIng=!1}})}function h(a){var d=b("#danmu .myComment"),e=a.length;return 1>e?void d.html(""):void c.init(d,a)}function i(){m.refreshComment||(m.refreshComment=!0,b.ajax({url:window.actionUrl.getUserInfo.url,type:window.actionUrl.getUserInfo.type,data:getCommonReqData(),success:function(a){a=checkReply(a),a&&h(a)},error:function(a){noNetwork()},complete:function(){m.refreshComment=!1}}))}var j,k,l,m={main_html:['<div class = "switch">','<div class = "danmuTitle">弹幕</div>','<div class = "greenBg">','<div class = "button"></div>',"</div>","</div>",'<div class = "discussZone" ></div>','<div class = "myComment"></div>'].join(""),refreshListIng:!1,refreshComment:!1,controller:-1};return j=function(a){m.$container=a,k(),l()},k=function(){var a=m.$container,b=m.main_html;a.html(b)},l=function(){var a=!0;g(),b("#danmu .switch").on("click",function(){if(0!=a)switch(a=!1,m.controller*=-1,m.controller){case-1:b("#danmu .discussZone").html(""),b("#danmu .myComment").html(""),b("#danmu .switch .greenBg").css({backgroundColor:"#a1a0a0"}),b("#danmu .switch .button").css("left","0.035rem"),setTimeout(function(){a=!0},500),m.refreshListIng=!0;break;case 1:b("#danmu .switch .greenBg").css({backgroundColor:"#1ead66"}),b("#danmu .switch .button").css("left","0.735rem"),setTimeout(function(){a=!0},500),m.refreshListIng=!1,f(m.data),i()}})},{init:j}}(window,$),c=function(b,c,e){function f(){j.refreshComment||(j.refreshComment=!0,c.ajax({url:window.actionUrl.sendBarrage.url,type:window.actionUrl.sendBarrage.type,data:j.theNewCommonReqData,success:function(a){if(0!=a.status)throw error("发送失败");console.log("发送成功")},error:function(a){noNetwork()},complete:function(){j.refreshComment=!1}}))}var g,h,i,j={main_html:['<div class = "userComment">','<div class="commentZone">','<div class="myHeadImg"></div>','<input class = "theComment" type="text" placeholder = "请写下你的评论..."/>',"</div>",'<div class = "send">发射</div>',"</div>"].join(""),refreshComment:!1};return g=function(a,b){j.$container=a,j.data=b,h(),i()},h=function(){var a=j.$container,b=j.data;a.html(j.main_html),lazyLoadImg(b.headImg,c("#danmu .myComment .userComment .myHeadImg"))},i=function(){var b=c("#danmu .userComment .send"),e=c("#danmu .userComment .theComment"),g=10,h=!0;b.on("click",function(){if(0!=h){var i=e.attr("value");if(""!=i.trim()){var k={},l=Math.floor(Math.random()*(window.tt.canvas.height-window.tt.itemHeight));if(k.uniId=j.data.uniId,k.head=j.data.headImg,k.num=0,k.text=i,k.parent=window.tt,k.pos={x:window.tt.canvas.width+Math.floor(40*Math.random()+40),y:l},k.uniId in window.tt.itemMap)return void console.log(j.data.uniId+"这个元素已经存在");window.tt.itemMap[k.uniId]=new d.DanMuItem(k),f(),e.get(0).value="",b.css("backgroundColor","#cccccc"),b.html("10"),h=!1,j.theNewCommonReqData=c.extend(getCommonReqData(),{actId:a,text:i});var m=setInterval(function(){g--,0>=g?(b.css("backgroundColor","#2b9f2c"),b.html("发射"),g=10,clearInterval(m),h=!0):b.html(g+"s")},1e3)}}})},window.String.prototype.trim=function(){return this.replace(/(^\s*)|(\s*$)/g,"")},{init:g}}(window,$),d=function(a,b,c){function d(c){l.refreshComment||(l.refreshComment=!0,b.ajax({url:a.actionUrl.praise.url,type:a.actionUrl.praise.type,data:b.extend(getCommonReqData(),{uniId:c}),success:function(a){if(0!=a.status)throw error("发送失败");console.log("发送成功")},error:function(a){noNetwork()},complete:function(){l.refreshComment=!1}}))}function e(b){if(!b||!b.canvas)throw"弹幕的canvas未指定";this.canvas=b.canvas,this.ctx=this.canvas.getContext("2d");var c=Math.floor(b.boxWidth||document.body.offsetWidth),d=Math.floor(b.boxHeight||500);this.canvas.style.width=c+"px",this.canvas.style.height=d+"px",this.dpi=a.devicePixelRatio||2,this.canvas.width=Math.floor(this.dpi*c),this.canvas.height=Math.floor(this.dpi*d),this.itemHeight=Math.floor(this.dpi*(b.itemHeight||30)),this.itemBorderColor=b.itemBorderColor||"#ffffff",this.itemBorderSize=Math.floor(this.dpi*(b.itemBorderSize||2)),this.bgColor=b.bgColor||"rgba(0,0,0,0.5)",this.textColor=b.textColor||"#ffffff",this.textSize=Math.floor(this.dpi*(b.textSize||14)),this.maxText=b.maxText||30,this.zanEmptyImg=b.zanEmptyImg,this.zanFillImg=b.zanFillImg,this.zanWidth=Math.floor(this.dpi*(b.zanWidth||18)),this.minSpeed=Math.floor(this.dpi*(b.minSpeed||5)),this.maxSpeed=Math.floor(this.dpi*(b.maxSpeed||10)),this.data=b.data||[],this.minNum=b.minNum||10,this.uni=0,this.zanOnload=!1,this.init()}function f(a){return this.parent=a.parent,this.head=a.head,this.text=a.text.substring(0,this.parent.maxText),this.num=a.num,this.pos=a.pos,this.uniId=a.uniId,this.ts=a.ts,this.hasNiced=!1,this.colorList=["rgb(112, 126, 172)","rgb(164, 75, 194)","rgb(121, 165, 86)","rgb(176, 67, 101)","rgb(83, 58, 183)","rgb(110, 178, 148)","#d73027","#b2182b","#4daf4a","#ff7f00","#984ea3"],this.niceColor=this.colorList[Math.floor(Math.random()*this.colorList.length)],this.init(),this}var g,h,i,j,k,l={main_html:['<canvas id = "discussCanvas" ></canvas>'].join("")};return g=function(a,b){l.data=b,l.$container=a,h(),i(),j()},k=parseInt(b(document.body).css("font-size")),h=function(){l.$container.html(l.main_html),l.canvas=document.getElementById("discussCanvas"),l.theBodyWidth=b(document.body).width(),l.theCanvasHeight=20.1*k,l.canvas.style.width=l.theBodyWidth+"px",l.canvas.style.height=l.theCanvasHeight+"px",l.canvas.width=dpi*l.theBodyWidth,l.canvas.height=dpi*l.theCanvasHeight},i=function(){a.tt=new e({canvas:Z("#discussCanvas")[0],data:l.data,minSpeed:1,maxSpeed:3.1,minNum:5,itemHeight:30,boxHeight:300,itemBorderSize:2,itemBorderColor:"#fff",textColor:"#fff",textSize:14,maxText:30,zanEmptyImg:"../img/danmu/zanEmpty.png",zanFillImg:"../img/danmu/zanFill.png",zanWidth:18,bgColor:"rgba(0,0,0,0.5)"}),a.tt.start()},j=function(){b("#discussCanvas").get(0).addEventListener("touchend",function(a){var b=a.changedTouches[0].clientX,c=a.changedTouches[0].clientY-4.8*k,e=tt.itemHeight,f={};for(var g in tt.itemMap){var h=tt.itemMap[g];b>=h.pos.x/dpi&&b<=(h.pos.x+h.canvas.width)/dpi&&c>=h.pos.y/dpi&&c<=(h.pos.y+e)/dpi&&(f=h,console.log(h.hasNiced))}f&&!f.hasNiced&&(d(f.uniId),f.hasNiced=!0,f.num++)})},e.prototype.unikey=function(){return"k"+ ++this.uni},e.prototype.add=function(a){if(a){var b,c,d=this,e=0;for(e=0;a>e;e++)d.dataIndex>=d.data.length&&(d.dataIndex=0),b=d.data[d.dataIndex++],c=Math.floor(Math.random()*(d.canvas.height-d.itemHeight)),d.itemMap[b.uniId]=new f({parent:d,uniId:b.uniId||0,head:b.headImg||"",text:b.text||"",num:b.praised||0,ts:b.ts||0,pos:{x:d.canvas.width+Math.floor(40*Math.random()+40),y:c}})}},e.prototype.start=function(){function b(){if(c.loop){var a;c.ctx.clearRect(0,0,c.canvas.width,c.canvas.height);var e=0;for(a in c.itemMap)c.itemMap[a].draw().move().died&&(delete c.itemMap[a],e++);c.add(e),d(b)}}var c=this;c.loop=!0;var d=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(b){a.setTimeout(b,17)};b()},e.prototype.stop=function(){this.loop=!1},e.prototype.init=function(){var a,b=this,c=b.itemBorderSize,d=b.itemHeight,e=b.itemBorderColor;b.headCanvas=document.createElement("canvas"),b.headCanvas.width=b.headCanvas.height=d,a=b.headCanvas.getContext("2d"),a.fillStyle=e;var f=d/2,g=f,h=f;a.beginPath(),a.arc(g,h,f,0,2*Math.PI),a.fill(),b.leftCircle=document.createElement("canvas"),b.leftCircle.height=d,b.leftCircle.width=Math.floor(d/2),a=b.leftCircle.getContext("2d"),a.fillStyle=b.bgColor,a.beginPath(),f=b.leftCircle.width-c,g=b.leftCircle.width,h=b.leftCircle.height/2,a.arc(g,h,f,.5*Math.PI,1.5*Math.PI),a.closePath(),a.fill(),a.fillStyle=e,a.beginPath(),a.moveTo(b.leftCircle.width,0),a.lineTo(b.leftCircle.width,c),a.arc(g,h,f,1.5*Math.PI,.5*Math.PI,!0),a.lineTo(b.leftCircle.width,b.leftCircle.height),f=b.leftCircle.width,a.arc(g,h,f,.5*Math.PI,1.5*Math.PI),a.closePath(),a.fill(),b.rightCircle=document.createElement("canvas"),b.rightCircle.height=d,b.rightCircle.width=Math.floor(d/2),a=b.rightCircle.getContext("2d"),a.fillStyle=b.bgColor,a.beginPath(),f=b.rightCircle.width-c,g=0,h=b.rightCircle.height/2,a.arc(g,h,f,1.5*Math.PI,.5*Math.PI),a.fill(),a.beginPath(),a.fillStyle=e,a.moveTo(0,0),a.lineTo(0,c),a.arc(g,h,f,1.5*Math.PI,.5*Math.PI),a.lineTo(0,b.rightCircle.height),f=b.rightCircle.width,a.arc(g,h,f,.5*Math.PI,1.5*Math.PI,!0),a.closePath(),a.fill(),b.centerBg=document.createElement("canvas"),b.centerBg.height=d,b.centerBg.width=b.centerBg.height;var i=b.centerBg.getContext("2d");i.fillStyle=b.bgColor,i.fillRect(0,c,b.centerBg.width,b.centerBg.height-2*c),i.fillStyle=e,i.fillRect(0,0,b.centerBg.width,c),i.fillRect(0,b.centerBg.height-c,b.centerBg.width,c);var j=new Image;j.src=b.zanEmptyImg,j.onload=function(){b.drawZan(this,"emptyZan"),delete this};var k=new Image;k.src=b.zanFillImg,k.onload=function(){b.drawZan(this,"fillZan"),delete this},b.itemMap={},b.dataIndex=0,b.add(b.minNum)},e.prototype.drawZan=function(a,b){var c=this;c.zanOnload=!0,c[b]=document.createElement("canvas"),c[b].width=a.width,c[b].height=a.height;var d=a.width,e=a.height;c[b].getContext("2d").drawImage(a,0,0,d,e)},f.prototype.init=function(){var a=this,b=a.parent;a.speed=Math.floor(b.minSpeed+Math.random()*(b.maxSpeed-b.minSpeed)),a.canvas=document.createElement("canvas"),a.canvas.height=b.itemHeight,a.rectWidth=(a.text.length+6)*b.textSize,a.canvas.width=a.rectWidth+b.itemHeight;var c=(""+a.num).length,d=a.num%10/10,e=Math.floor(b.zanWidth+b.textSize*c),f=Math.floor((a.canvas.width-b.itemHeight)*d-b.itemHeight);a.niceFullWidth=Math.floor(1*(a.canvas.width-b.itemHeight)-b.itemHeight),a.buttonWidth=Math.max(e,f),a.numWidth=c*b.textSize/1.5,a.niceWidth=3*b.textSize/2,a.died=!1,a.drawNiceContent(),a.drawNum("before"),a.drawNum("after"),a.drawBuff();var g=document.createElement("img");return g.onload=function(){a.drawHead(this),delete this},g.src=a.head,a},f.prototype.drawHead=function(a){var b=this;if(a&&!b.died){var c=b.parent,d=document.createElement("canvas"),e=d.getContext("2d"),f=a.width,g=a.height,h=c.itemHeight-2*c.itemBorderSize;d.width=h,d.height=h;var i,j,k,l;g>f?(i=h/f,j=i*g,k=0,l=(h-j)/2,e.drawImage(a,k,l,h,j)):(i=h/g,j=i*f,k=(h-j)/2,l=0,e.drawImage(a,k,l,j,h));var m=h/2,n=h/2,o=h/2;e.save(),e.beginPath(),e.arc(m,n,o,0,1*Math.PI),e.lineTo(0,h),e.lineTo(h,h),e.closePath(),e.clip(),e.clearRect(0,0,h,h),e.restore(),e.beginPath(),e.arc(m,n,o,0,1*Math.PI,!0),e.lineTo(0,0),e.lineTo(h,0),e.closePath(),e.clip(),e.clearRect(0,0,h,h);var p=c.itemBorderSize;e=b.canvas.getContext("2d"),e.drawImage(d,p,p)}},f.prototype.drawNiceContent=function(){var a,b=this,c=this.parent,d=c.itemHeight,e=c.itemBorderSize,f=b.canvas.height;b.rightNiceCircle=document.createElement("canvas"),b.rightNiceCircle.height=d,b.rightNiceCircle.width=Math.floor(d/2),a=b.rightNiceCircle.getContext("2d"),a.fillStyle=b.niceColor,a.beginPath();var g=b.rightNiceCircle.width-e,h=0,i=b.rightNiceCircle.height/2;a.arc(h,i,g,1.5*Math.PI,.5*Math.PI),a.fill(),b.leftNiceCircle=document.createElement("canvas"),b.leftNiceCircle.height=d,b.leftNiceCircle.width=Math.floor(d/2),a=b.leftNiceCircle.getContext("2d"),a.fillStyle=b.niceColor,a.beginPath();var g=b.leftNiceCircle.width-e,h=b.leftNiceCircle.width,i=b.leftNiceCircle.height/2;a.arc(h,i,g,.5*Math.PI,1.5*Math.PI),a.closePath(),a.fill(),b.niceCenterBg=document.createElement("canvas"),b.niceCenterBg.height=d,b.niceCenterBg.width=b.niceCenterBg.height;var j=b.niceCenterBg.getContext("2d");j.fillStyle=b.niceColor,j.fillRect(0,e,b.niceCenterBg.width,b.niceCenterBg.height-2*e),b.content=document.createElement("canvas"),b.content.height=d,b.content.width=b.canvas.width;var k=b.content.getContext("2d");k.fillStyle=c.textColor,k.font=c.textSize+"px Microsoft YaHei";var l=Math.floor(.4*(f-c.textSize));k.textBaseline="top",k.fillText(b.text,Math.floor(1.5*f),l)},f.prototype.drawBuff=function(){var a=this;if(a.died)return a;var b=a.parent,c=a.canvas.getContext("2d"),d=a.canvas.width,e=a.canvas.height;Math.floor(e/2),b.itemBorderSize;return c.drawImage(b.headCanvas,0,0),c.drawImage(b.leftCircle,e,0),c.drawImage(b.rightCircle,Math.floor(d-.5*e),0),c.drawImage(b.centerBg,Math.floor(1.5*e),0,Math.floor(d-2*e),e),a},f.prototype.drawNum=function(a){var b=this,c=this.parent,d=c.itemHeight,e=b.canvas.height,f=Math.floor(.4*(e-c.textSize)),g="before"==a?b.num:b.num+1,h=b.canvas.width;b[a+"Num"]=document.createElement("canvas"),b[a+"Num"].height=d,b[a+"Num"].width=b.canvas.width,b[a+"Num"].ctx=b[a+"Num"].getContext("2d"),b[a+"Num"].ctx.fillStyle=c.textColor,b[a+"Num"].ctx.font=c.textSize+"px Microsoft YaHei",b[a+"Num"].ctx.textBaseline="top",b[a+"Num"].ctx.fillText(g,Math.floor(h-.5*e-c.zanWidth),f)},f.prototype.move=function(){var a=this;return a.pos.x-=a.speed,a.pos.x<-a.canvas.width&&a.die(),a},f.prototype.die=function(){var a=this;return a.died?a:(a.died=!0,delete a.canvas,a.canvas=null,a)},f.prototype.draw=function(){var a=this,b=a.parent,c=(a.canvas.getContext("2d"),a.canvas.width),d=a.canvas.height,e=Math.floor(.4*(d-b.textSize)),f=a.pos.x+Math.floor(c-.5*d-b.zanWidth-a.niceWidth),g=a.pos.y+e,h=b.zanWidth;return!a.died&&a.pos.x<b.canvas.width&&(b.ctx.drawImage(a.canvas,a.pos.x,a.pos.y),a.hasNiced&&a.buttonWidth<=a.niceFullWidth&&(a.buttonWidth=Math.ceil(a.buttonWidth+(a.niceFullWidth-a.buttonWidth)/5)),b.ctx.drawImage(a.rightNiceCircle,a.pos.x+Math.floor(c-.5*d),a.pos.y),b.ctx.drawImage(a.niceCenterBg,a.pos.x+Math.floor(c-.5*d-a.buttonWidth),a.pos.y,a.buttonWidth,d),b.ctx.drawImage(a.leftNiceCircle,a.pos.x+Math.floor(c-.5*d-a.buttonWidth-.5*d),a.pos.y),b.ctx.drawImage(a.content,a.pos.x,a.pos.y),a.hasNiced?(b.ctx.drawImage(b.fillZan,f,g,h,h),b.ctx.drawImage(a.afterNum,a.pos.x,a.pos.y)):(b.ctx.drawImage(b.emptyZan,f,g,h,h),b.ctx.drawImage(a.beforeNum,a.pos.x,a.pos.y))),a},{init:g,DanMuItem:f}}(window,$);document.body.className="noTab",b.init($("#danmu"))});
>>>>>>> develop
